<!DOCTYPE html>
<html lang="en">
<head>
    <title>Climate in Hamburg and Munich</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style>
        .glyphicon.spinning {
            font-size: 50px;
            animation: spin 1s infinite linear;
            -webkit-animation: spin2 1s infinite linear;
        }

        @keyframes spin {
            from { transform: scale(1) rotate(0deg);}
            to { transform: scale(1) rotate(360deg);}
        }

        @-webkit-keyframes spin2 {
            from { -webkit-transform: rotate(0deg);}
            to { -webkit-transform: rotate(360deg);}
        }

        .spinner{
            position: absolute;
            height: 100px;
            width: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -50px;
            z-index: 11;
        }

        #graph {
            position: relative;
        }

        .overlay {
            opacity: .5;
            filter: Alpha(Opacity=50);
            background-color: #f6f6f6;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2px;
        }

        .grid-background {
            fill: #ddd;
        }

        .axisBrush path {
            display: none;
        }

        .axisBrush line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .grid line,
        .grid path {
            fill: none;
            stroke: #fff;
            shape-rendering: crispEdges;
        }

        .grid .minor.tick line {
            stroke-opacity: .5;
        }

        .brush .extent {
            stroke: #000;
            fill-opacity: .125;
            shape-rendering: crispEdges;
        }
    </style>
</head>
<body>
<div class="container">

    <h1>Climate in Hamburg and Munich</h1>
    <h2>Comparison of temperature and humidity since 1949</h2>

    <div id="spinner" class="spinner">
        <span class="glyphicon glyphicon-refresh spinning"></span>
    </div>
    <div id="graph" class="overlay"></div>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script>
    function loading(state) {
        if(state) {
            $("#spinner").show();
            $("#graph").addClass("overlay");
        } else {
            $("#spinner").hide();
            $("#graph").removeClass("overlay");
        }
    }

    var start = new Date(1950, 0, 1),
        end = new Date(1960, 11, 31),
        granularity = "YEAR";

    function getGranularity() {
        return granularity;
    }

    function getStart() {
        return start;
    }

    function getEnd() {
        return end;
    }

    function toDateString(date) {
        var isoString = date.toISOString();
        return isoString.substring(0, isoString.length - 1);
    }

    function getStartAndEnd() {
        if(getStart() && getEnd()) {
            return "&start=" + toDateString(getStart()) + "&end=" + toDateString(getEnd());
        } else {
            return "";
        }
    }

    function setStartAndEnd(newStart, newEnd) {
        start = newStart;
        end = newEnd;
        loadData();
    }

    function convertDate(dateArray) {
        //              YEAR                       MONTH              DAY                HOUR               MINUTE             SECOND
        return new Date(dateArray[0] || dateArray, dateArray[1] || 1, dateArray[2] || 1, dateArray[3] || 0, dateArray[4] || 0, dateArray[5] || 0);
    }

    function adjustData(data) {
        var newData = [];
        for (i=0; i<data.length; ++i) {
            newData.push({
                date: convertDate(data[i][0]),
                value: data[i][1]
            });
        }
        return newData;
    }

    var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom,
            heightBrush = 200 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%d-%b-%y").parse;

    var x = d3.time.scale().range([0, width]),
        y = d3.scale.linear().range([height, 0]),
        brush;

    var x2 = d3.time.scale().range([0, width]);

    var xAxis = d3.svg.axis().scale(x).orient("bottom"),
        yAxis = d3.svg.axis().scale(y).orient("left");

    var line = d3.svg.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.value); });

    var svg = d3.select("#graph").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var svgBrush = d3.select("#graph").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", heightBrush + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    function loadData(init) {
        loading(true);

        var url = "/api/sensor/temperature?selected="+getGranularity()+getStartAndEnd();

        d3.json(url, function(error, result) {
            var data = adjustData(result.data[0]);

            if (error) throw error;

            x.domain(d3.extent(data, function(d) { return d.date; }));
            y.domain(d3.extent(data, function(d) { return d.value; }));

            if(init) {
                draw(data);
            } else {
                update(data);
            }
            loadBrush(data, init);
        });

        loading(false);
    }

    function draw(data) {
        svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Temperature");

        svg.append("path")
                .attr("class", "line")
                .attr("d", line(data));
    }

    function update(data) {
        var chart = d3.select("#graph").transition();

        chart.select(".x.axis")
                .duration(750)
                .call(xAxis);

        chart.select(".y.axis")
                .duration(750)
                .call(yAxis);

        chart.select(".line")
                .duration(750)
                .attr("d", line(data));
    }

    function getTicks() {
        return getTimeLevel().range;
    }

    function getFineGrainedTicks() {
        return getFineGrainedTimeLevel().range;
    }

    function getFineGrainedTicksCount() {
        var granularity = getGranularity();
        if(granularity == "YEAR") return 6;
        if(granularity == "MONTH") return 15;
        if(granularity == "DAY") return 12;
        if(granularity == "HOUR") return 30;
        return 30;
    }

    function getTimeLevel() {
        var granularity = getGranularity();
        if(granularity == "YEAR") return d3.time.year;
        if(granularity == "MONTH") return d3.time.month;
        if(granularity == "DAY") return d3.time.day;
        if(granularity == "HOUR") return d3.time.hour;
        return d3.time.minute;
    }

    function getFineGrainedTimeLevel() {
        var granularity = getGranularity();
        if(granularity == "YEAR") return d3.time.month;
        if(granularity == "MONTH") return d3.time.day;
        if(granularity == "DAY") return d3.time.hour;
        if(granularity == "HOUR") return d3.time.minute;
        return d3.time.second;
    }

    function brushended() {
        if (!d3.event.sourceEvent) return; // only transition after input
        var extent0 = brush.extent(),
                extent1 = extent0.map(getTimeLevel().round);

        // if empty when rounded, use floor & ceil instead
        if (extent1[0] >= extent1[1]) {
            extent1[0] = getTimeLevel().floor(extent0[0]);
            extent1[1] = getTimeLevel().ceil(extent0[1]);
        }

        d3.select(this).transition()
                .call(brush.extent(extent1))
                .call(brush.event);

        setStartAndEnd(extent1[0], extent1[1]);
    }

    function loadBrush(data, init) {
        x2.domain(d3.extent(data, function(d) { return d.date; }));

        brush =  d3.svg.brush()
                .x(x2)
                .on("brushend", brushended);

        if(init) {
            drawBrush(data);
        } else {
            updateBrush(data);
            brush.extent([getStart(), getEnd()])
        }
    }

    var xGrid = d3.svg.axis()
            .scale(x2)
            .orient("bottom")
            .ticks(getFineGrainedTicks(), getFineGrainedTicksCount())
            .tickSize(-heightBrush)
            .tickFormat("");

    var xAxisBrush = d3.svg.axis()
            .scale(x2)
            .orient("bottom")
            .ticks(getTicks())
            .tickPadding(0);

    function drawBrush(data) {
        svgBrush.append("rect")
                .attr("class", "grid-background")
                .attr("width", width)
                .attr("height", heightBrush);

        svgBrush.append("g")
                .attr("class", "x grid")
                .attr("transform", "translate(0," + heightBrush + ")")
                .call(xGrid)
                .selectAll(".tick")
                .classed("minor", function(d) { return d.getHours(); });

        svgBrush.append("g")
                .attr("class", "x axisBrush")
                .attr("transform", "translate(0," + heightBrush + ")")
                .call(xAxisBrush)
                .selectAll("text")
                .attr("x", 6)
                .style("text-anchor", null);

        var gBrush = svgBrush.append("g")
                .attr("class", "brush")
                .call(brush)
                .call(brush.event);

        gBrush.selectAll("rect")
                .attr("height", heightBrush);
    }

    function updateBrush(data) {
        var chart = d3.select("#graph").transition();

        chart.select(".x.grid")
                .duration(750)
                .call(xGrid.ticks(getFineGrainedTicks(), getFineGrainedTicksCount()));

        chart.select(".x.axisBrush")
                .duration(750)
                .call(xAxisBrush.ticks(getTicks()));

        chart.select(".brush")
                .duration(750)
                .call(brush.clear());
    }

    loadData(true);
</script>
</body>
</html>