<!DOCTYPE html>
<html lang="en">
<head>
    <title>Line Chart Demo</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style>
        .glyphicon.spinning {
            font-size: 50px;
            animation: spin 1s infinite linear;
            -webkit-animation: spin2 1s infinite linear;
        }

        @keyframes spin {
            from { transform: scale(1) rotate(0deg);}
            to { transform: scale(1) rotate(360deg);}
        }

        @-webkit-keyframes spin2 {
            from { -webkit-transform: rotate(0deg);}
            to { -webkit-transform: rotate(360deg);}
        }

        .spinner{
            position: absolute;
            height: 100px;
            width: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -50px;
            z-index: 11;
        }

        #graph {
            position: relative;
        }

        .overlay {
            opacity: .5;
            filter:Alpha(Opacity=50);
            background-color: #f6f6f6;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }
    </style>
</head>
<body>
<div class="container">

    <h1>InteractiveData - Sample</h1>
    <h2>Line chart with multiple lines, time filter and granularity</h2>

    <div class="form-inline">
        <label for="start">Filter: </label>
        <input type="date" name="start" id="start" class="form-control" />
        <input type="date" name="end" id="end" class="form-control" />
        <button id="btnResetTimeFilter" class="btn btn-default"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>

        <label for="granularity">Granularity: </label>
        <select id="granularity" name="granularity" class="form-control">
            <option value="SECOND">Second</option>
            <option value="MINUTE">Minute</option>
            <option value="HOUR">Hour</option>
            <option value="DAY">Day</option>
            <option value="MONTH">Month</option>
            <option value="YEAR" selected>Year</option>
        </select>

        <button id="btnApply" class="btn btn-primary"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></button>
        <button id="save" class="btn btn-primary"><span class="glyphicon glyphicon-save" aria-hidden="true"></span></button>
        <button id="btnInfo" class="btn btn-primary" type="button" data-toggle="modal" data-target="#requestInfoModal"><span class="glyphicon glyphicon-eye-open"></span></button>
    </div>

    <div id="spinner" class="spinner">
        <span class="glyphicon glyphicon-refresh spinning"></span>
    </div>
    <div id="graph" class="overlay"></div>

    <!-- Request Info Modal -->
    <div class="modal fade" id="requestInfoModal" tabindex="-1" role="dialog" aria-labelledby="requestInfoModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="requestInfoModalLabel">Latest Request Info</h4>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <tr>
                            <th scope="row">Time</th>
                            <td id="requestTime">no Request</td>
                            <td>Seconds</td>
                        </tr>
                        <tr>
                            <th scope="row">Size</th>
                            <td id="requestSize">no Request</td>
                            <td>KiB</td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js" charset="utf-8"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script>
    var lastRequestTime = null;
    var lastRequestSize = null;

    $("#btnResetTimeFilter").click(function() {
        $("#start").val("");
        $("#end").val("");
    });
    $("#btnApply").click(function() {
        loadData();
    });

    function loading(state) {
        if(state) {
            $("#spinner").show();
            $("#graph").addClass("overlay");
        } else {
            $("#spinner").hide();
            $("#graph").removeClass("overlay");
        }
    }

    function getGranularity() {
        return $("#granularity").val()
    }

    function getStartAndEnd() {
        var start = $("#start").val();
        var end = $("#end").val();
        if(start && end) {
            return "&start=" + start + "T00:00:00&end=" + end + "T23:59:59";
        } else {
            return "";
        }
    }

    function setStartAndEnd(start, end) {
        $("#start").val(start.getFullYear() + "-" + ("0"+(start.getMonth()+1)).slice(-2) + "-" + ("0" + start.getDate()).slice(-2) );
        $("#end").val(end.getFullYear() + "-" +("0"+(end.getMonth()+1)).slice(-2) + "-" +("0" + end.getDate()).slice(-2) );
        loadData();
    }

    function convertDate(dateArray) {
        //              YEAR                       MONTH              DAY                HOUR               MINUTE             SECOND
        return new Date(dateArray[0] || dateArray, dateArray[1] || 1, dateArray[2] || 1, dateArray[3] || 0, dateArray[4] || 0, dateArray[5] || 0);
    }

    function adjustData(data) {
        var newData = [];
        for (i=0; i<data.length; ++i) {
            newData.push({
                date: convertDate(data[i][0]),
                value: data[i][1]
            });
        }
        return newData;
    }

    var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%d-%b-%y").parse;

    var x = d3.time.scale()
            .range([0, width]);

    var y = d3.scale.linear()
            .range([height, 0]);

    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

    var line = d3.svg.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.value); });

    var svg = d3.select("#graph").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    function loadData() {
        loading(true);

        var url = "/api/db/actionsline1?selected="+getGranularity()+getStartAndEnd();

        d3.json(url, function(error, result) {
            var data = adjustData(result.data[0]);

            if (error) throw error;

            data.forEach(function(d) {
                d.date = +d.date;
                d.value = +d.value;
            });

            x.domain(d3.extent(data, function(d) { return d.date; }));
            y.domain(d3.extent(data, function(d) { return d.value; }));

            svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

            svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Value");

            svg.append("path")
                    .datum(data)
                    .attr("class", "line")
                    .attr("d", line);
        });

        loading(false);
    }

    loadData();
</script>
</body>
</html>